- name: Make sure that nginx and https work correctly for the app
  hosts: intbot_nginx

  tasks:
    - name: Copy nginx configuration file
      ansible.builtin.template:
        src: nginx/nginx.conf.j2
        dest: ./nginx.conf
        mode: "0644"

    - name: Create a server Makefile (for nginx) to manage on-server tasks
      ansible.builtin.template:
        src: nginx/Makefile.nginx.j2
        dest: ./Makefile
        mode: "0640"

    - name: Set up docker-compose.yml on the remote server
      ansible.builtin.template:
        src: nginx/docker-compose.nginx.yml.j2
        dest: ./docker-compose.yml
        mode: "0640"

    - name: Make sure the directory structure for certs exist
      ansible.builtin.file:
        path: "/home/{{ ansible_user }}/data/certbot/conf"
        state: directory
        mode: "0755"

    - name: Display info at the end
      ansible.builtin.debug:
        msg: "Go to /home/{{ ansible_user }} and run make certbot/init-staging; then make certbot/upgrade-to-prod"
